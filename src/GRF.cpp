#include "pico/stdlib.h"
#include <stdio.h>
#include <math.h>
#include <iostream>
#include <vector>
#include "hardware/i2c.h"
using namespace std;
#ifndef M_PI
#define M_PI 3.14159265358979323846
#endif
#include <cmath>
#include <iostream>
#include <bno08x.h>
#include "utils.h"
// Test 
#include "GRF.h"
#include "hardware/gpio.h"
#include "hardware/adc.h"

extern BNO08x IMU;

float pitch = 0.0f, yaw = 0.0f, roll= 0.0f;
float accX = 0.0f, accY = 0.0f, accZ = 0.0f; // Accelerometer values
float gyroX = 0.0f, gyroY = 0.0f, gyroZ = 0.0f; // Gyroscope values
float angleX = 0.0f, angleY = 0.0f, angleZ = 0.0f; // Angle values
uint16_t adcresult; //starting ADC
bool adcbool = false; //ADC boolean
vector <float> thresholdAngle = {-1.45f};

// // Initialize velocities
vector <float> v_IMU= {0,0,0};
vector <float> v_shank= {0,0,0};
vector <float> v_thigh= {0,0,0};
vector <float> v_knee= {0,0,0};
vector <float> v_hip= {0,0,0};
vector <float> pre_v_shank= {0,0,0};
vector <float> pre_v_thigh= {0,0,0};
vector <float> pre_v_knee= {0,0,0};
vector <float> pre_v_hip= {0,0,0};
vector <float> w_thigh= {0,0,0};
vector <float> w_IMU= {0,0,0};

// Initialize acceleration variables
vector <float> a_IMU = {0,0,0};
vector<float> a_shank = {0,0,0};
vector<float> a_thigh = {0,0,0};
vector<float> a_hip = {0,0,0};
vector<float> pre_a_IMU = {0,0,0};

//Initialize angles
vector <float> pre_angle_thigh = {0,0,0};
vector<float> angle_IMU;

//Initialize length vectors
vector <float> L_shank;
vector <float> L_shank_COM;
vector <float> L_thigh;
vector <float> L_thigh_COM;

// Initialize GRF
vector<float> GRF;

// Lookup table thigh angle
vector<float> LookUp_shank = {-3.14159265358979,
    -3.13530317880783,
    -3.12901370402587,
    -3.12272422924391,
    -3.11643475446195,
    -3.11014527967999,
    -3.10385580489802,
    -3.09756633011606,
    -3.09127685533410,
    -3.08498738055214,
    -3.07869790577018,
    -3.07240843098822,
    -3.06611895620625,
    -3.05982948142429,
    -3.05354000664233,
    -3.04725053186037,
    -3.04096105707841,
    -3.03467158229645,
    -3.02838210751449,
    -3.02209263273252,
    -3.01580315795056,
    -3.00951368316860,
    -3.00322420838664,
    -2.99693473360468,
    -2.99064525882272,
    -2.98435578404075,
    -2.97806630925879,
    -2.97177683447683,
    -2.96548735969487,
    -2.95919788491291,
    -2.95290841013095,
    -2.94661893534899,
    -2.94032946056702,
    -2.93403998578506,
    -2.92775051100310,
    -2.92146103622114,
    -2.91517156143918,
    -2.90888208665722,
    -2.90259261187525,
    -2.89630313709329,
    -2.89001366231133,
    -2.88372418752937,
    -2.87743471274741,
    -2.87114523796545,
    -2.86485576318349,
    -2.85856628840152,
    -2.85227681361956,
    -2.84598733883760,
    -2.83969786405564,
    -2.83340838927368,
    -2.82711891449172,
    -2.82082943970975,
    -2.81453996492779,
    -2.80825049014583,
    -2.80196101536387,
    -2.79567154058191,
    -2.78938206579995,
    -2.78309259101798,
    -2.77680311623602,
    -2.77051364145406,
    -2.76422416667210,
    -2.75793469189014,
    -2.75164521710818,
    -2.74535574232622,
    -2.73906626754425,
    -2.73277679276229,
    -2.72648731798033,
    -2.72019784319837,
    -2.71390836841641,
    -2.70761889363445,
    -2.70132941885248,
    -2.69503994407052,
    -2.68875046928856,
    -2.68246099450660,
    -2.67617151972464,
    -2.66988204494268,
    -2.66359257016072,
    -2.65730309537875,
    -2.65101362059679,
    -2.64472414581483,
    -2.63843467103287,
    -2.63214519625091,
    -2.62585572146895,
    -2.61956624668698,
    -2.61327677190502,
    -2.60698729712306,
    -2.60069782234110,
    -2.59440834755914,
    -2.58811887277718,
    -2.58182939799522,
    -2.57553992321325,
    -2.56925044843129,
    -2.56296097364933,
    -2.55667149886737,
    -2.55038202408541,
    -2.54409254930345,
    -2.53780307452148,
    -2.53151359973952,
    -2.52522412495756,
    -2.51893465017560,
    -2.51264517539364,
    -2.50635570061168,
    -2.50006622582972,
    -2.49377675104775,
    -2.48748727626579,
    -2.48119780148383,
    -2.47490832670187,
    -2.46861885191991,
    -2.46232937713795,
    -2.45603990235598,
    -2.44975042757402,
    -2.44346095279206,
    -2.43717147801010,
    -2.43088200322814,
    -2.42459252844618,
    -2.41830305366422,
    -2.41201357888225,
    -2.40572410410029,
    -2.39943462931833,
    -2.39314515453637,
    -2.38685567975441,
    -2.38056620497245,
    -2.37427673019048,
    -2.36798725540852,
    -2.36169778062656,
    -2.35540830584460,
    -2.34911883106264,
    -2.34282935628068,
    -2.33653988149872,
    -2.33025040671675,
    -2.32396093193479,
    -2.31767145715283,
    -2.31138198237087,
    -2.30509250758891,
    -2.29880303280695,
    -2.29251355802498,
    -2.28622408324302,
    -2.27993460846106,
    -2.27364513367910,
    -2.26735565889714,
    -2.26106618411518,
    -2.25477670933322,
    -2.24848723455125,
    -2.24219775976929,
    -2.23590828498733,
    -2.22961881020537,
    -2.22332933542341,
    -2.21703986064145,
    -2.21075038585948,
    -2.20446091107752,
    -2.19817143629556,
    -2.19188196151360,
    -2.18559248673164,
    -2.17930301194968,
    -2.17301353716771,
    -2.16672406238575,
    -2.16043458760379,
    -2.15414511282183,
    -2.14785563803987,
    -2.14156616325791,
    -2.13527668847595,
    -2.12898721369398,
    -2.12269773891202,
    -2.11640826413006,
    -2.11011878934810,
    -2.10382931456614,
    -2.09753983978418,
    -2.09125036500221,
    -2.08496089022025,
    -2.07867141543829,
    -2.07238194065633,
    -2.06609246587437,
    -2.05980299109241,
    -2.05351351631045,
    -2.04722404152848,
    -2.04093456674652,
    -2.03464509196456,
    -2.02835561718260,
    -2.02206614240064,
    -2.01577666761868,
    -2.00948719283671,
    -2.00319771805475,
    -1.99690824327279,
    -1.99061876849083,
    -1.98432929370887,
    -1.97803981892691,
    -1.97175034414495,
    -1.96546086936298,
    -1.95917139458102,
    -1.95288191979906,
    -1.94659244501710,
    -1.94030297023514,
    -1.93401349545318,
    -1.92772402067121,
    -1.92143454588925,
    -1.91514507110729,
    -1.90885559632533,
    -1.90256612154337,
    -1.89627664676141,
    -1.88998717197945,
    -1.88369769719748,
    -1.87740822241552,
    -1.87111874763356,
    -1.86482927285160,
    -1.85853979806964,
    -1.85225032328768,
    -1.84596084850571,
    -1.83967137372375,
    -1.83338189894179,
    -1.82709242415983,
    -1.82080294937787,
    -1.81451347459591,
    -1.80822399981394,
    -1.80193452503198,
    -1.79564505025002,
    -1.78935557546806,
    -1.78306610068610,
    -1.77677662590414,
    -1.77048715112218,
    -1.76419767634021,
    -1.75790820155825,
    -1.75161872677629,
    -1.74532925199433,
    -1.73903977721237,
    -1.73275030243041,
    -1.72646082764844,
    -1.72017135286648,
    -1.71388187808452,
    -1.70759240330256,
    -1.70130292852060,
    -1.69501345373864,
    -1.68872397895668,
    -1.68243450417471,
    -1.67614502939275,
    -1.66985555461079,
    -1.66356607982883,
    -1.65727660504687,
    -1.65098713026491,
    -1.64469765548294,
    -1.63840818070098,
    -1.63211870591902,
    -1.62582923113706,
    -1.61953975635510,
    -1.61325028157314,
    -1.60696080679118,
    -1.60067133200921,
    -1.59438185722725,
    -1.58809238244529,
    -1.58180290766333,
    -1.57551343288137,
    -1.56922395809941,
    -1.56293448331744,
    -1.55664500853548,
    -1.55035553375352,
    -1.54406605897156,
    -1.53777658418960,
    -1.53148710940764,
    -1.52519763462568,
    -1.51890815984371,
    -1.51261868506175,
    -1.50632921027979,
    -1.50003973549783,
    -1.49375026071587,
    -1.48746078593391,
    -1.48117131115194,
    -1.47488183636998,
    -1.46859236158802,
    -1.46230288680606,
    -1.45601341202410,
    -1.44972393724214,
    -1.44343446246018,
    -1.43714498767821,
    -1.43085551289625,
    -1.42456603811429,
    -1.41827656333233,
    -1.41198708855037,
    -1.40569761376841,
    -1.39940813898644,
    -1.39311866420448,
    -1.38682918942252,
    -1.38053971464056,
    -1.37425023985860,
    -1.36796076507664,
    -1.36167129029468,
    -1.35538181551271,
    -1.34909234073075,
    -1.34280286594879,
    -1.33651339116683,
    -1.33022391638487,
    -1.32393444160291,
    -1.31764496682094,
    -1.31135549203898,
    -1.30506601725702,
    -1.29877654247506,
    -1.29248706769310,
    -1.28619759291114,
    -1.27990811812918,
    -1.27361864334721,
    -1.26732916856525,
    -1.26103969378329,
    -1.25475021900133,
    -1.24846074421937,
    -1.24217126943741,
    -1.23588179465544,
    -1.22959231987348,
    -1.22330284509152,
    -1.21701337030956,
    -1.21072389552760,
    -1.20443442074564,
    -1.19814494596367,
    -1.19185547118171,
    -1.18556599639975,
    -1.17927652161779,
    -1.17298704683583,
    -1.16669757205387,
    -1.16040809727191,
    -1.15411862248994,
    -1.14782914770798,
    -1.14153967292602,
    -1.13525019814406,
    -1.12896072336210,
    -1.12267124858014,
    -1.11638177379817,
    -1.11009229901621,
    -1.10380282423425,
    -1.09751334945229,
    -1.09122387467033,
    -1.08493439988837,
    -1.07864492510641,
    -1.07235545032444,
    -1.06606597554248,
    -1.05977650076052,
    -1.05348702597856,
    -1.04719755119660,
    -1.04090807641464,
    -1.03461860163267,
    -1.02832912685071,
    -1.02203965206875,
    -1.01575017728679,
    -1.00946070250483,
    -1.00317122772287,
    -0.996881752940905,
    -0.990592278158944,
    -0.984302803376982,
    -0.978013328595021,
    -0.971723853813059,
    -0.965434379031098,
    -0.959144904249136,
    -0.952855429467174,
    -0.946565954685213,
    -0.940276479903251,
    -0.933987005121290,
    -0.927697530339328,
    -0.921408055557367,
    -0.915118580775405,
    -0.908829105993444,
    -0.902539631211482,
    -0.896250156429521,
    -0.889960681647559,
    -0.883671206865597,
    -0.877381732083636,
    -0.871092257301674,
    -0.864802782519713,
    -0.858513307737751,
    -0.852223832955790,
    -0.845934358173828,
    -0.839644883391867,
    -0.833355408609905,
    -0.827065933827944,
    -0.820776459045982,
    -0.814486984264020,
    -0.808197509482059,
    -0.801908034700097,
    -0.795618559918136,
    -0.789329085136174,
    -0.783039610354213,
    -0.776750135572251,
    -0.770460660790290,
    -0.764171186008328,
    -0.757881711226367,
    -0.751592236444405,
    -0.745302761662443,
    -0.739013286880482,
    -0.732723812098520,
    -0.726434337316559,
    -0.720144862534597,
    -0.713855387752636,
    -0.707565912970674,
    -0.701276438188713,
    -0.694986963406751,
    -0.688697488624789,
    -0.682408013842828,
    -0.676118539060866,
    -0.669829064278905,
    -0.663539589496943,
    -0.657250114714982,
    -0.650960639933020,
    -0.644671165151059,
    -0.638381690369097,
    -0.632092215587136,
    -0.625802740805174,
    -0.619513266023212,
    -0.613223791241251,
    -0.606934316459289,
    -0.600644841677328,
    -0.594355366895366,
    -0.588065892113405,
    -0.581776417331443,
    -0.575486942549482,
    -0.569197467767520,
    -0.562907992985559,
    -0.556618518203597,
    -0.550329043421635,
    -0.544039568639674,
    -0.537750093857712,
    -0.531460619075751,
    -0.525171144293789,
    -0.518881669511828,
    -0.512592194729866,
    -0.506302719947905,
    -0.500013245165943,
    -0.493723770383981,
    -0.487434295602020,
    -0.481144820820058,
    -0.474855346038097,
    -0.468565871256135,
    -0.462276396474174,
    -0.455986921692212,
    -0.449697446910251,
    -0.443407972128289,
    -0.437118497346328,
    -0.430829022564366,
    -0.424539547782404,
    -0.418250073000443,
    -0.411960598218481,
    -0.405671123436520,
    -0.399381648654558,
    -0.393092173872597,
    -0.386802699090635,
    -0.380513224308674,
    -0.374223749526712,
    -0.367934274744751,
    -0.361644799962789,
    -0.355355325180827,
    -0.349065850398866,
    -0.342776375616904,
    -0.336486900834943,
    -0.330197426052981,
    -0.323907951271020,
    -0.317618476489058,
    -0.311329001707097,
    -0.305039526925135,
    -0.298750052143174,
    -0.292460577361212,
    -0.286171102579250,
    -0.279881627797289,
    -0.273592153015327,
    -0.267302678233366,
    -0.261013203451404,
    -0.254723728669443,
    -0.248434253887481,
    -0.242144779105520,
    -0.235855304323558,
    -0.229565829541597,
    -0.223276354759635,
    -0.216986879977673,
    -0.210697405195712,
    -0.204407930413750,
    -0.198118455631789,
    -0.191828980849827,
    -0.185539506067866,
    -0.179250031285904,
    -0.172960556503943,
    -0.166671081721981,
    -0.160381606940019,
    -0.154092132158058,
    -0.147802657376096,
    -0.141513182594135,
    -0.135223707812173,
    -0.128934233030212,
    -0.122644758248250,
    -0.116355283466289,
    -0.110065808684327,
    -0.103776333902366,
    -0.0974868591204040,
    -0.0911973843384424,
    -0.0849079095564809,
    -0.0786184347745193,
    -0.0723289599925578,
    -0.0660394852105962,
    -0.0597500104286347,
    -0.0534605356466732,
    -0.0471710608647116,
    -0.0408815860827501,
    -0.0345921113007885,
    -0.0283026365188270,
    -0.0220131617368654,
    -0.0157236869549039,
    -0.00943421217294232,
    -0.00314473739098077,
    0.00314473739098077,
    0.00943421217294232,
    0.0157236869549039,
    0.0220131617368654,
    0.0283026365188270,
    0.0345921113007885,
    0.0408815860827501,
    0.0471710608647116,
    0.0534605356466732,
    0.0597500104286347,
    0.0660394852105962,
    0.0723289599925578,
    0.0786184347745193,
    0.0849079095564809,
    0.0911973843384424,
    0.0974868591204040,
    0.103776333902366,
    0.110065808684327,
    0.116355283466289,
    0.122644758248250,
    0.128934233030212,
    0.135223707812173,
    0.141513182594135,
    0.147802657376096,
    0.154092132158058,
    0.160381606940019,
    0.166671081721981,
    0.172960556503943,
    0.179250031285904,
    0.185539506067866,
    0.191828980849827,
    0.198118455631789,
    0.204407930413750,
    0.210697405195712,
    0.216986879977673,
    0.223276354759635,
    0.229565829541597,
    0.235855304323558,
    0.242144779105520,
    0.248434253887481,
    0.254723728669443,
    0.261013203451404,
    0.267302678233366,
    0.273592153015327,
    0.279881627797289,
    0.286171102579250,
    0.292460577361212,
    0.298750052143174,
    0.305039526925135,
    0.311329001707097,
    0.317618476489058,
    0.323907951271020,
    0.330197426052981,
    0.336486900834943,
    0.342776375616904,
    0.349065850398866,
    0.355355325180827,
    0.361644799962789,
    0.367934274744751,
    0.374223749526712,
    0.380513224308674,
    0.386802699090635,
    0.393092173872597,
    0.399381648654558,
    0.405671123436520,
    0.411960598218481,
    0.418250073000443,
    0.424539547782404,
    0.430829022564366,
    0.437118497346328,
    0.443407972128289,
    0.449697446910251,
    0.455986921692212,
    0.462276396474174,
    0.468565871256135,
    0.474855346038097,
    0.481144820820058,
    0.487434295602020,
    0.493723770383981,
    0.500013245165943,
    0.506302719947905,
    0.512592194729866,
    0.518881669511828,
    0.525171144293789,
    0.531460619075751,
    0.537750093857712,
    0.544039568639674,
    0.550329043421635,
    0.556618518203597,
    0.562907992985559,
    0.569197467767520,
    0.575486942549482,
    0.581776417331443,
    0.588065892113405,
    0.594355366895366,
    0.600644841677328,
    0.606934316459289,
    0.613223791241251,
    0.619513266023212,
    0.625802740805174,
    0.632092215587136,
    0.638381690369097,
    0.644671165151059,
    0.650960639933020,
    0.657250114714982,
    0.663539589496943,
    0.669829064278905,
    0.676118539060866,
    0.682408013842828,
    0.688697488624789,
    0.694986963406751,
    0.701276438188713,
    0.707565912970674,
    0.713855387752636,
    0.720144862534597,
    0.726434337316559,
    0.732723812098520,
    0.739013286880482,
    0.745302761662443,
    0.751592236444405,
    0.757881711226367,
    0.764171186008328,
    0.770460660790290,
    0.776750135572251,
    0.783039610354213,
    0.789329085136174,
    0.795618559918136,
    0.801908034700097,
    0.808197509482059,
    0.814486984264020,
    0.820776459045982,
    0.827065933827944,
    0.833355408609905,
    0.839644883391867,
    0.845934358173828,
    0.852223832955790,
    0.858513307737751,
    0.864802782519713,
    0.871092257301674,
    0.877381732083636,
    0.883671206865597,
    0.889960681647559,
    0.896250156429521,
    0.902539631211482,
    0.908829105993444,
    0.915118580775405,
    0.921408055557367,
    0.927697530339328,
    0.933987005121290,
    0.940276479903251,
    0.946565954685213,
    0.952855429467174,
    0.959144904249136,
    0.965434379031098,
    0.971723853813059,
    0.978013328595021,
    0.984302803376982,
    0.990592278158944,
    0.996881752940905,
    1.00317122772287,
    1.00946070250483,
    1.01575017728679,
    1.02203965206875,
    1.02832912685071,
    1.03461860163267,
    1.04090807641464,
    1.04719755119660,
    1.05348702597856,
    1.05977650076052,
    1.06606597554248,
    1.07235545032444,
    1.07864492510641,
    1.08493439988837,
    1.09122387467033,
    1.09751334945229,
    1.10380282423425,
    1.11009229901621,
    1.11638177379817,
    1.12267124858014,
    1.12896072336210,
    1.13525019814406,
    1.14153967292602,
    1.14782914770798,
    1.15411862248994,
    1.16040809727191,
    1.16669757205387,
    1.17298704683583,
    1.17927652161779,
    1.18556599639975,
    1.19185547118171,
    1.19814494596367,
    1.20443442074564,
    1.21072389552760,
    1.21701337030956,
    1.22330284509152,
    1.22959231987348,
    1.23588179465544,
    1.24217126943741,
    1.24846074421937,
    1.25475021900133,
    1.26103969378329,
    1.26732916856525,
    1.27361864334721,
    1.27990811812918,
    1.28619759291114,
    1.29248706769310,
    1.29877654247506,
    1.30506601725702,
    1.31135549203898,
    1.31764496682094,
    1.32393444160291,
    1.33022391638487,
    1.33651339116683,
    1.34280286594879,
    1.34909234073075,
    1.35538181551271,
    1.36167129029468,
    1.36796076507664,
    1.37425023985860,
    1.38053971464056,
    1.38682918942252,
    1.39311866420448,
    1.39940813898644,
    1.40569761376841,
    1.41198708855037,
    1.41827656333233,
    1.42456603811429,
    1.43085551289625,
    1.43714498767821,
    1.44343446246018,
    1.44972393724214,
    1.45601341202410,
    1.46230288680606,
    1.46859236158802,
    1.47488183636998,
    1.48117131115194,
    1.48746078593391,
    1.49375026071587,
    1.50003973549783,
    1.50632921027979,
    1.51261868506175,
    1.51890815984371,
    1.52519763462568,
    1.53148710940764,
    1.53777658418960,
    1.54406605897156,
    1.55035553375352,
    1.55664500853548,
    1.56293448331744,
    1.56922395809941,
    1.57551343288137,
    1.58180290766333,
    1.58809238244529,
    1.59438185722725,
    1.60067133200921,
    1.60696080679118,
    1.61325028157314,
    1.61953975635510,
    1.62582923113706,
    1.63211870591902,
    1.63840818070098,
    1.64469765548294,
    1.65098713026491,
    1.65727660504687,
    1.66356607982883,
    1.66985555461079,
    1.67614502939275,
    1.68243450417471,
    1.68872397895668,
    1.69501345373864,
    1.70130292852060,
    1.70759240330256,
    1.71388187808452,
    1.72017135286648,
    1.72646082764844,
    1.73275030243041,
    1.73903977721237,
    1.74532925199433,
    1.75161872677629,
    1.75790820155825,
    1.76419767634021,
    1.77048715112218,
    1.77677662590414,
    1.78306610068610,
    1.78935557546806,
    1.79564505025002,
    1.80193452503198,
    1.80822399981394,
    1.81451347459591,
    1.82080294937787,
    1.82709242415983,
    1.83338189894179,
    1.83967137372375,
    1.84596084850571,
    1.85225032328768,
    1.85853979806964,
    1.86482927285160,
    1.87111874763356,
    1.87740822241552,
    1.88369769719748,
    1.88998717197945,
    1.89627664676141,
    1.90256612154337,
    1.90885559632533,
    1.91514507110729,
    1.92143454588925,
    1.92772402067121,
    1.93401349545318,
    1.94030297023514,
    1.94659244501710,
    1.95288191979906,
    1.95917139458102,
    1.96546086936298,
    1.97175034414495,
    1.97803981892691,
    1.98432929370887,
    1.99061876849083,
    1.99690824327279,
    2.00319771805475,
    2.00948719283671,
    2.01577666761868,
    2.02206614240064,
    2.02835561718260,
    2.03464509196456,
    2.04093456674652,
    2.04722404152848,
    2.05351351631045,
    2.05980299109241,
    2.06609246587437,
    2.07238194065633,
    2.07867141543829,
    2.08496089022025,
    2.09125036500221,
    2.09753983978418,
    2.10382931456614,
    2.11011878934810,
    2.11640826413006,
    2.12269773891202,
    2.12898721369398,
    2.13527668847595,
    2.14156616325791,
    2.14785563803987,
    2.15414511282183,
    2.16043458760379,
    2.16672406238575,
    2.17301353716771,
    2.17930301194968,
    2.18559248673164,
    2.19188196151360,
    2.19817143629556,
    2.20446091107752,
    2.21075038585948,
    2.21703986064145,
    2.22332933542341,
    2.22961881020537,
    2.23590828498733,
    2.24219775976929,
    2.24848723455125,
    2.25477670933322,
    2.26106618411518,
    2.26735565889714,
    2.27364513367910,
    2.27993460846106,
    2.28622408324302,
    2.29251355802498,
    2.29880303280695,
    2.30509250758891,
    2.31138198237087,
    2.31767145715283,
    2.32396093193479,
    2.33025040671675,
    2.33653988149872,
    2.34282935628068,
    2.34911883106264,
    2.35540830584460,
    2.36169778062656,
    2.36798725540852,
    2.37427673019048,
    2.38056620497245,
    2.38685567975441,
    2.39314515453637,
    2.39943462931833,
    2.40572410410029,
    2.41201357888225,
    2.41830305366422,
    2.42459252844618,
    2.43088200322814,
    2.43717147801010,
    2.44346095279206,
    2.44975042757402,
    2.45603990235598,
    2.46232937713795,
    2.46861885191991,
    2.47490832670187,
    2.48119780148383,
    2.48748727626579,
    2.49377675104775,
    2.50006622582972,
    2.50635570061168,
    2.51264517539364,
    2.51893465017560,
    2.52522412495756,
    2.53151359973952,
    2.53780307452148,
    2.54409254930345,
    2.55038202408541,
    2.55667149886737,
    2.56296097364933,
    2.56925044843129,
    2.57553992321325,
    2.58182939799522,
    2.58811887277718,
    2.59440834755914,
    2.60069782234110,
    2.60698729712306,
    2.61327677190502,
    2.61956624668698,
    2.62585572146895,
    2.63214519625091,
    2.63843467103287,
    2.64472414581483,
    2.65101362059679,
    2.65730309537875,
    2.66359257016072,
    2.66988204494268,
    2.67617151972464,
    2.68246099450660,
    2.68875046928856,
    2.69503994407052,
    2.70132941885248,
    2.70761889363445,
    2.71390836841641,
    2.72019784319837,
    2.72648731798033,
    2.73277679276229,
    2.73906626754425,
    2.74535574232622,
    2.75164521710818,
    2.75793469189014,
    2.76422416667210,
    2.77051364145406,
    2.77680311623602,
    2.78309259101798,
    2.78938206579995,
    2.79567154058191,
    2.80196101536387,
    2.80825049014583,
    2.81453996492779,
    2.82082943970975,
    2.82711891449172,
    2.83340838927368,
    2.83969786405564,
    2.84598733883760,
    2.85227681361956,
    2.85856628840152,
    2.86485576318349,
    2.87114523796545,
    2.87743471274741,
    2.88372418752937,
    2.89001366231133,
    2.89630313709329,
    2.90259261187525,
    2.90888208665722,
    2.91517156143918,
    2.92146103622114,
    2.92775051100310,
    2.93403998578506,
    2.94032946056702,
    2.94661893534899,
    2.95290841013095,
    2.95919788491291,
    2.96548735969487,
    2.97177683447683,
    2.97806630925879,
    2.98435578404075,
    2.99064525882272,
    2.99693473360468,
    3.00322420838664,
    3.00951368316860,
    3.01580315795056,
    3.02209263273252,
    3.02838210751449,
    3.03467158229645,
    3.04096105707841,
    3.04725053186037,
    3.05354000664233,
    3.05982948142429,
    3.06611895620625,
    3.07240843098822,
    3.07869790577018,
    3.08498738055214,
    3.09127685533410,
    3.09756633011606,
    3.10385580489802,
    3.11014527967999,
    3.11643475446195,
    3.12272422924391,
    3.12901370402587,
    3.13530317880783,
    3.14159265358979};
vector<float> LookUp_thigh = {-2.02312674768301,
-2.01864199264022,
-2.01415723759743,
-2.00967248255464,
-2.00518772751185,
-2.00070297246906,
-1.99621821742627,
-1.99173346238348,
-1.98724870734069,
-1.98276395229790,
-1.97827919725511,
-1.97379444221232,
-1.96930968716953,
-1.96482493212674,
-1.92913124403211,
-1.90882021309204,
-1.89266546488713,
-1.87850486835183,
-1.86558117260445,
-1.85352250784139,
-1.84211338356695,
-1.83121564009997,
-1.82073438538198,
-1.81060109659173,
-1.80076436692500,
-1.79118445189333,
-1.78182986598640,
-1.77267515940108,
-1.76369941012536,
-1.75488516862447,
-1.74621769935839,
-1.73768442302112,
-1.72927449814263,
-1.72097850170546,
-1.71278818154915,
-1.70469626176664,
-1.69669628785094,
-1.68878250209258,
-1.68094974230090,
-1.67319335872247,
-1.66550914531131,
-1.65789328243062,
-1.65034228874337,
-1.64285298055122,
-1.63542243721830,
-1.62804797160182,
-1.62072710463026,
-1.61345754333909,
-1.60623716180556,
-1.59906398452795,
-1.59193617187636,
-1.58485200730771,
-1.57780988609023,
-1.57080830532480,
-1.56384585508539,
-1.55692121052864,
-1.55003312484597,
-1.54318042295085,
-1.53636199580927,
-1.52957679533529,
-1.52282382978396,
-1.51610215958382,
-1.50941089355860,
-1.50274918549447,
-1.49611623101516,
-1.48951126473160,
-1.48293355763724,
-1.47638241472366,
-1.46985717279396,
-1.46335719845434,
-1.45688188626637,
-1.45043065704444,
-1.44400295628480,
-1.43759825271377,
-1.43121603694443,
-1.42485582023186,
-1.41851713331836,
-1.41219952536074,
-1.40590256293263,
-1.39962582909556,
-1.39336892253308,
-1.38713145674268,
-1.38091305928098,
-1.37471337105782,
-1.36853204567555,
-1.36236874880996,
-1.35622315762970,
-1.35009496025127,
-1.34398385522697,
-1.33788955106350,
-1.33181176576873,
-1.32575022642498,
-1.31970466878667,
-1.31367483690084,
-1.30766048274878,
-1.30166136590757,
-1.29567725323003,
-1.28970791854193,
-1.28375314235529,
-1.27781271159686,
-1.27188641935060,
-1.26597406461350,
-1.26007545206375,
-1.25419039184060,
-1.24831869933511,
-1.24246019499128,
-1.23661470411668,
-1.23078205670240,
-1.22496208725134,
-1.21915463461481,
-1.21335954183652,
-1.20757665600394,
-1.20180582810635,
-1.19604691289930,
-1.19029976877519,
-1.18456425763950,
-1.17884024479254,
-1.17312759881623,
-1.16742619146581,
-1.16173589756619,
-1.15605659491258,
-1.15038816417535,
-1.14473048880883,
-1.13908345496375,
-1.13344695140342,
-1.12782086942308,
-1.12220510277266,
-1.11659954758245,
-1.11100410229177,
-1.10541866758041,
-1.09984314630265,
-1.09427744342388,
-1.08872146595959,
-1.08317512291665,
-1.07763832523676,
-1.07211098574207,
-1.06659301908266,
-1.06108434168611,
-1.05558487170869,
-1.05009452898848,
-1.04461323500004,
-1.03914091281071,
-1.03367748703845,
-1.02822288381113,
-1.02277703072727,
-1.01733985681801,
-1.01191129251050,
-1.00649126959246,
-1.00107972117791,
-0.995676581674094,
-0.990281786749420,
-0.984895273302537,
-0.979516979432347,
-0.974146844409018,
-0.968784808645924,
-0.963430813672466,
-0.958084802107773,
-0.952746717635210,
-0.947416504977693,
-0.942094109873768,
-0.936779479054425,
-0.931472560220625,
-0.926173302021504,
-0.920881654033246,
-0.915597566738582,
-0.910320991506904,
-0.905051880574974,
-0.899790187028191,
-0.894535864782421,
-0.889288868566342,
-0.884049153904315,
-0.878816677099737,
-0.873591395218878,
-0.868373266075174,
-0.863162248213970,
-0.857958300897685,
-0.852761384091400,
-0.847571458448847,
-0.842388485298778,
-0.837212426631724,
-0.832043245087102,
-0.826880903940686,
-0.821725367092412,
-0.816576599054514,
-0.811434564939980,
-0.806299230451312,
-0.801170561869596,
-0.796048526043849,
-0.790933090380657,
-0.785824222834080,
-0.780721891895823,
-0.775626066585663,
-0.770536716442121,
-0.765453811513384,
-0.760377322348445,
-0.755307219988489,
-0.750243475958483,
-0.745186062258985,
-0.740134951358168,
-0.735090116184032,
-0.730051530116819,
-0.725019166981623,
-0.719993001041173,
-0.714973006988806,
-0.709959159941609,
-0.704951435433729,
-0.699949809409859,
-0.694954258218869,
-0.689964758607602,
-0.684981287714826,
-0.680003823065322,
-0.675032342564126,
-0.670066824490908,
-0.665107247494484,
-0.660153590587467,
-0.655205833141042,
-0.650263954879871,
-0.645327935877120,
-0.640397756549600,
-0.635473397653038,
-0.630554840277444,
-0.625642065842607,
-0.620735056093686,
-0.615833793096912,
-0.610938259235395,
-0.606048437205024,
-0.601164310010475,
-0.596285860961310,
-0.591413073668165,
-0.586545932039039,
-0.581684420275663,
-0.576828522869966,
-0.571978224600615,
-0.567133510529650,
-0.562294365999187,
-0.557460776628218,
-0.552632728309471,
-0.547810207206360,
-0.542993199749999,
-0.538181692636301,
-0.533375672823135,
-0.528575127527565,
-0.523780044223147,
-0.518990410637303,
-0.514206214748754,
-0.509427444785019,
-0.504654089219981,
-0.499886136771506,
-0.495123576399134,
-0.490366397301823,
-0.485614588915750,
-0.480868140912175,
-0.476127043195356,
-0.471391285900525,
-0.466660859391913,
-0.461935754260829,
-0.457215961323795,
-0.452501471620733,
-0.447792276413195,
-0.443088367182651,
-0.438389735628823,
-0.433696373668070,
-0.429008273431812,
-0.424325427265012,
-0.419647827724699,
-0.414975467578532,
-0.410308339803419,
-0.405646437584169,
-0.400989754312197,
-0.396338283584264,
-0.391692019201267,
-0.387050955167063,
-0.382415085687342,
-0.377784405168532,
-0.373158908216757,
-0.368538589636818,
-0.363923444431229,
-0.359313467799284,
-0.354708655136162,
-0.350109002032074,
-0.345514504271446,
-0.340925157832139,
-0.336340958884705,
-0.331761903791683,
-0.327187989106932,
-0.322619211574990,
-0.318055568130486,
-0.313497055897572,
-0.308943672189400,
-0.304395414507629,
-0.299852280541972,
-0.295314268169769,
-0.290781375455606,
-0.286253600650961,
-0.281730942193884,
-0.277213398708716,
-0.272700969005836,
-0.268193652081448,
-0.263691447117397,
-0.259194353481022,
-0.254702370725039,
-0.250215498587463,
-0.245733736991559,
-0.241257086045825,
-0.236785546044019,
-0.232319117465206,
-0.227857800973845,
-0.223401597419914,
-0.218950507839059,
-0.214504533452788,
-0.210063675668685,
-0.205627936080672,
-0.201197316469297,
-0.196771818802056,
-0.192351445233753,
-0.187936198106893,
-0.183526079952108,
-0.179121093488621,
-0.174721241624739,
-0.170326527458390,
-0.165936954277688,
-0.161552525561538,
-0.157173244980273,
-0.152799116396331,
-0.148430143864969,
-0.144066331635008,
-0.139707684149621,
-0.135354206047158,
-0.131005902162005,
-0.126662777525482,
-0.122324837366788,
-0.117992087113971,
-0.113664532394948,
-0.109342179038561,
-0.105025033075674,
-0.100713100740313,
-0.0964063884708399,
-0.0921049029111787,
-0.0878086509120770,
-0.0835176395324130,
-0.0792318760405452,
-0.0749513679157078,
-0.0706761228494491,
-0.0664061487471171,
-0.0621414537293900,
-0.0578820461338548,
-0.0536279345166326,
-0.0493791276540528,
-0.0451356345443765,
-0.0408974644095697,
-0.0366646266971276,
-0.0324371310819507,
-0.0282149874682730,
-0.0239982059916445,
-0.0197867970209674,
-0.0155807711605889,
-0.0113801392524493,
-0.00718491237828880,
-0.00299510186191193,
0.00118928072848723,
0.00536822357793946,
0.00954171462225245,
0.0137097415454994,
0.0178722917774431,
0.0220293524908937,
0.0261809105989994,
0.0303269527524680,
0.0344674653367187,
0.0386024344689616,
0.0427318459952045,
0.0468556854871843,
0.0509739382392219,
0.0550865892649994,
0.0591936232942568,
0.0632950247694070,
0.0673907778420671,
0.0714808663695042,
0.0755652739109938,
0.0796439837240881,
0.0837169787607926,
0.0877842416636493,
0.0918457547617226,
0.0959015000664879,
0.0999514592676181,
0.103995613728667,
0.108033944482649,
0.112066432227501,
0.116093057321451,
0.120113799778248,
0.124128639262298,
0.128137555083664,
0.132140526192951,
0.136137531176058,
0.140128548248806,
0.144113555251428,
0.148092529642926,
0.152065448495284,
0.156032288487537,
0.159993025899691,
0.163947636606494,
0.167896096071047,
0.171838379338250,
0.175774461028092,
0.179704315328763,
0.183627915989589,
0.187545236313795,
0.191456249151074,
0.195360926889970,
0.199259241450061,
0.203151164273943,
0.207036666319004,
0.210915718048978,
0.214788289425289,
0.218654349898159,
0.222513868397479,
0.226366813323446,
0.230213152536947,
0.234052853349679,
0.237885882514018,
0.241712206212595,
0.245531790047613,
0.249344599029847,
0.253150597567364,
0.256949749453921,
0.260742017857046,
0.264527365305787,
0.268305753678118,
0.272077144187991,
0.275841497372028,
0.279598773075823,
0.283348930439870,
0.287091927885071,
0.290827723097834,
0.294556273014742,
0.298277533806765,
0.301991460863016,
0.305698008774027,
0.309397131314521,
0.313088781425683,
0.316772911196883,
0.320449471846857,
0.324118413704312,
0.327779686187936,
0.331433237785793,
0.335079016034081,
0.338716967495221,
0.342347037735269,
0.345969171300600,
0.349583311693860,
0.353189401349146,
0.356787381606376,
0.360377192684843,
0.363958773655886,
0.367532062414676,
0.371096995651055,
0.374653508819404,
0.378201536107505,
0.381741010404330,
0.385271863266749,
0.388794024885080,
0.392307424047449,
0.395811988102906,
0.399307642923243,
0.402794312863455,
0.406271920720793,
0.409740387692336,
0.413199633331027,
0.416649575500102,
0.420090130325828,
0.423521212148494,
0.426942733471558,
0.430354604908872,
0.433756735129895,
0.437149030802797,
0.440531396535362,
0.443903734813571,
0.447265945937764,
0.450617927956264,
0.453959576596331,
0.457290785192316,
0.460611444610883,
0.463921443173134,
0.467220666573503,
0.470508997795229,
0.473786317022246,
0.477052501547297,
0.480307425676069,
0.483550960627150,
0.486782974427558,
0.490003331803628,
0.493211894066983,
0.496408518995317,
0.499593060707713,
0.502765369534167,
0.505925291878993,
0.509072670077765,
0.512207342247392,
0.515329142128950,
0.518437898922807,
0.521533437115596,
0.524615576298531,
0.527684130976519,
0.530738910367508,
0.533779718191439,
0.536806352448144,
0.539818605183458,
0.542816262242799,
0.545799103011349,
0.548766900139953,
0.551719419255770,
0.554656418656599,
0.557577648987759,
0.560482852900287,
0.563371764689101,
0.566244109909680,
0.569099604971680,
0.571937956707762,
0.574758861915746,
0.577562006872059,
0.580347066814228,
0.583113705389982,
0.585861574070269,
0.588590311523281,
0.591299542946233,
0.593988879351386,
0.596657916802385,
0.599306235596636,
0.601933399388974,
0.604538954251369,
0.607122427662864,
0.609683327423303,
0.612221140483686,
0.614735331685181,
0.617225342397904,
0.619690589049539,
0.622130461532682,
0.624544321478445,
0.626931500382308,
0.629291297566437,
0.631622977960656,
0.633925769681913,
0.636198861389389,
0.638441399389238,
0.640652484459349,
0.642831168360235,
0.644976449993232,
0.647087271161367,
0.649162511881407,
0.651200985187523,
0.653201431357431,
0.655162511480454,
0.657082800273321,
0.658960778033142,
0.660794821597270,
0.662583194155798,
0.664324033733328,
0.666015340120898,
0.667654959995016,
0.669240569906216,
0.670769656751630,
0.672239495260715,
0.673647121915426,
0.674989304588634,
0.676262507008010,
0.677462846923755,
0.678586046559226,
0.679627373527960,
0.680581569872336,
0.681442766165068,
0.682204376637346,
0.682858969940869,
0.683398108239194,
0.683812144584380,
0.684089964536436,
0.684218652026555,
0.684183050387077,
0.683965175276403,
0.683543413378448,
0.682891402737498,
0.681976424860657,
0.680757019887901,
0.679179309594488,
0.677171052603520,
0.674631443660691,
0.671412206815545,
0.667278694721292,
0.661816809865900,
0.654148879953892,
0.641499410561332,
0.618393972520536,
0.622878727563326,
0.627363482606117,
0.631848237648907,
0.636332992691697,
0.640817747734488,
0.645302502777278,
0.649787257820069,
0.654272012862859,
0.658756767905650,
0.663241522948440,
0.667726277991230,
0.672211033034021,
0.676695788076811,
0.681180543119602,
0.685665298162392,
0.690150053205182,
0.694634808247973,
0.699119563290763,
0.703604318333554,
0.708089073376344,
0.712573828419134,
0.717058583461925,
0.721543338504715,
0.726028093547506,
0.730512848590296,
0.734997603633086,
0.739482358675877,
0.743967113718667,
0.748451868761458,
0.752936623804248,
0.757421378847038,
0.761906133889829,
0.766390888932619,
0.770875643975410,
0.775360399018200,
0.779845154060991,
0.784329909103781,
0.788814664146571,
0.793299419189362,
0.797784174232152,
0.802268929274943,
0.806753684317733,
0.811238439360523,
0.815723194403314,
0.820207949446104,
0.824692704488895,
0.829177459531685,
0.833662214574475,
0.838146969617266,
0.842631724660056,
0.847116479702847,
0.851601234745637,
0.856085989788427,
0.860570744831218,
0.865055499874008,
0.869540254916799,
0.874025009959589,
0.878509765002379,
0.882994520045170,
0.887479275087960,
0.891964030130751,
0.896448785173541,
0.900933540216332,
0.905418295259122,
0.909903050301912,
0.914387805344703,
0.918872560387493,
0.923357315430284,
0.927842070473074,
0.932326825515864,
0.936811580558655,
0.941296335601445,
0.945781090644236,
0.950265845687026,
0.954750600729816,
0.959235355772607,
0.963720110815397,
0.968204865858188,
0.972689620900978,
0.977174375943768,
0.981659130986559,
0.986143886029349,
0.990628641072140,
0.995113396114930,
0.999598151157721,
1.00408290620051,
1.00856766124330,
1.01305241628609,
1.01753717132888,
1.02202192637167,
1.02650668141446,
1.03099143645725,
1.03547619150004,
1.03996094654283,
1.04444570158562,
1.04893045662842,
1.05341521167121,
1.05789996671400,
1.06238472175679,
1.06686947679958,
1.07135423184237,
1.07583898688516,
1.08032374192795,
1.08480849697074,
1.08929325201353,
1.09377800705632,
1.09826276209911,
1.10274751714190,
1.10723227218469,
1.11171702722748,
1.11620178227027,
1.12068653731306,
1.12517129235585,
1.12965604739864,
1.13414080244143,
1.13862555748422,
1.14311031252701,
1.14759506756980,
1.15207982261259,
1.15656457765538,
1.16104933269818,
1.16553408774097,
1.17001884278376,
1.17450359782655,
1.17898835286934,
1.18347310791213,
1.18795786295492,
1.19244261799771,
1.19692737304050,
1.20141212808329,
1.20589688312608,
1.21038163816887,
1.21486639321166,
1.21935114825445,
1.22383590329724,
1.22832065834003,
1.23280541338282,
1.23729016842561,
1.24177492346840,
1.24625967851119,
1.25074443355398,
1.25522918859677,
1.25971394363956,
1.26419869868235,
1.26868345372515,
1.27316820876794,
1.27765296381073,
1.28213771885352,
1.28662247389631,
1.29110722893910,
1.29559198398189,
1.30007673902468,
1.30456149406747,
1.30904624911026,
1.31353100415305,
1.31801575919584,
1.32250051423863,
1.32698526928142,
1.33147002432421,
1.33595477936700,
1.34043953440979,
1.34492428945258,
1.34940904449537,
1.35389379953816,
1.35837855458095,
1.36286330962374,
1.36734806466653,
1.37183281970932,
1.37631757475211,
1.38080232979491,
1.38528708483770,
1.38977183988049,
1.39425659492328,
1.39874134996607,
1.40322610500886,
1.40771086005165,
1.41219561509444,
1.41668037013723,
1.42116512518002,
1.42564988022281,
1.43013463526560,
1.43461939030839,
1.43910414535118,
1.44358890039397,
1.44807365543676,
1.45255841047955,
1.45704316552234,
1.46152792056513,
1.46601267560792,
1.47049743065071,
1.47498218569350,
1.47946694073629,
1.48395169577908,
1.48843645082188,
1.49292120586467,
1.49740596090746,
1.50189071595025,
1.50637547099304,
1.51086022603583,
1.51534498107862,
1.51982973612141,
1.52431449116420,
1.52879924620699,
1.53328400124978,
1.53776875629257,
1.54225351133536,
1.54673826637815,
1.55122302142094,
1.55570777646373,
1.56019253150652,
1.56467728654931,
1.56916204159210,
1.57364679663489,
1.57813155167768,
1.58261630672047,
1.58710106176326,
1.59158581680605,
1.59607057184884,
1.60055532689164,
1.60504008193443,
1.60952483697722,
1.61400959202001,
1.61849434706280,
1.62297910210559,
1.62746385714838,
1.63194861219117,
1.63643336723396,
1.64091812227675,
1.64540287731954,
1.64988763236233,
1.65437238740512,
1.65885714244791,
1.66334189749070,
1.66782665253349,
1.67231140757628,
1.67679616261907,
1.68128091766186,
1.68576567270465,
1.69025042774744,
1.69473518279023,
1.69921993783302,
1.70370469287581,
1.70818944791861,
1.71267420296140,
1.71715895800419,
1.72164371304698,
1.72612846808977,
1.73061322313256,
1.73509797817535,
1.73958273321814,
1.74406748826093,
1.74855224330372,
1.75303699834651,
1.75752175338930,
1.76200650843209,
1.76649126347488,
1.77097601851767,
1.77546077356046,
1.77994552860325,
1.78443028364604,
1.78891503868883,
1.79339979373162,
1.79788454877441,
1.80236930381720,
1.80685405885999,
1.81133881390278,
1.81582356894557,
1.82030832398837,
1.82479307903116,
1.82927783407395,
1.83376258911674,
1.83824734415953,
1.84273209920232,
1.84721685424511,
1.85170160928790,
1.85618636433069,
1.86067111937348,
1.86515587441627,
1.86964062945906,
1.87412538450185,
1.87861013954464,
1.88309489458743,
1.88757964963022,
1.89206440467301,
1.89654915971580,
1.90103391475859,
1.90551866980138,
1.91000342484417,
1.91448817988696,
1.91897293492975,
1.92345768997254,
1.92794244501534,
1.93242720005813,
1.93691195510092,
1.94139671014371,
1.94588146518650,
1.95036622022929,
1.95485097527208,
1.95933573031487,
1.96382048535766,
1.96830524040045,
1.97278999544324,
1.97727475048603,
1.98175950552882,
1.98624426057161,
1.99072901561440,
1.99521377065719,
1.99969852569998,
2.00418328074277,
2.00866803578556,
2.01315279082835,
2.01763754587114,
2.02212230091393,
2.02660705595672,
2.03109181099951,
2.03557656604231,
2.04006132108510,
2.04454607612789,
2.04903083117068,
2.05351558621347,
2.05800034125626,
2.06248509629905,
2.06696985134184,
2.07145460638463,
2.07593936142742,
2.08042411647021,
2.08490887151300,
2.08939362655579,
2.09387838159858,
2.09836313664137,
2.10284789168416,
2.10733264672695,
2.11181740176974,
2.11630215681253,
2.12078691185532,
2.12527166689811,
2.12975642194090,
2.13424117698369,
2.13872593202648,
2.14321068706927,
2.14769544211207,
2.15218019715486,
2.15666495219765,
2.16114970724044,
2.16563446228323,
2.17011921732602,
2.17460397236881,
2.17908872741160,
2.18357348245439,
2.18805823749718,
2.19254299253997,
2.19702774758276,
2.20151250262555,
2.20599725766834,
2.21048201271113,
2.21496676775392,
2.21945152279671,
2.22393627783950,
2.22842103288229,
2.23290578792508,
2.23739054296787,
2.24187529801066,
2.24636005305345,
2.25084480809624,
2.25532956313903,
2.25981431818183,
2.26429907322462,
2.26878382826741,
2.27326858331020,
2.27775333835299,
2.28223809339578,
2.28672284843857,
2.29120760348136,
2.29569235852415,
2.30017711356694,
2.30466186860973,
2.30914662365252,
2.31363137869531,
2.31811613373810,
2.32260088878089,
2.32708564382368,
2.33157039886647,
2.33605515390926,
2.34053990895205,
2.34502466399484,
2.34950941903763,
2.35399417408042,
2.35847892912321,
2.36296368416600,
2.36744843920880,
2.37193319425159,
2.37641794929438,
2.38090270433717,
2.38538745937996,
2.38987221442275,
2.39435696946554,
2.39884172450833,
2.40332647955112,
2.40781123459391,
2.41229598963670,
2.41678074467949,
2.42126549972228,
2.42575025476507,
2.43023500980786,
2.43471976485065,
2.43920451989344,
2.44368927493623,
2.44817402997902,
2.45265878502181,
2.45714354006460,
};

// Constants
float COM_shank = 0.5726;  // Values taken from paper in Zotero
float COM_thigh = 0.4095;
float dt = 0.005f;  // Time step for 200Hz (5 miliseconds between calculations)
float conversion_factor = 3.3f / (1 << 12); //for ADC

float timeStamp = 0.0f;
int stepDetector = 0;
float stepCounter = 0.0f;
float pre_stepCounter = 0.0f;
float magnitude = 0.0f;
vector<float> angle_thigh;
extern float start_time;

//CHANGE: ALPHA VALUE
float alpha = 0.1f;

// CHANGE: INITIALIZE THE RAW DATA VECTORS
// Raw data vectors
vector<float> a_IMU_raw = {0,0,0};
vector<float> w_IMU_raw = {0,0,0};
vector<float> angle_IMU_raw = {0,0,0};

// Function to compute the length vectors for shank and thigh
vector<float> calculate_length(vector<float> angle, float length){
    float L_x = (length/100) * sin(angle[1]);
    float L_y = 0.00f;
    float L_z = (length/100) * cos(angle[1]);
    return {L_x, L_y, L_z};
}

// Function enrtywise multiplication
vector<float> entrywise_mul(vector<float> L, float COM){
    float L_x = L[0] * COM;
    float L_y = L[1] * COM;
    float L_z = L[2] * COM;
    return{L_x, L_y, L_z};
}

// Function enrtywise addition
vector<float> entrywise_add(vector<float> vect_A, vector<float> vect_B){
    float vect_Cx = vect_A[0] + vect_B[0];
    float vect_Cy = vect_A[1] + vect_B[1];
    float vect_Cz = vect_A[2] + vect_B[2];
    return{vect_Cx, vect_Cy, vect_Cz};
}

// Function to estimate the thigh angle
vector<float> estimate_angle_thigh(vector<float> angle, vector<float> LookUp_shank, vector<float> LookUp_thigh){
    float closest = LookUp_shank[0];
    int closestIndex = 0;
    float minDiff = abs(angle[1] - closest);

    for(int i = 1; i < LookUp_shank.size(); i++){
        float diff = abs(angle[1] - LookUp_shank[i]);
        if(diff < minDiff){
            closest = LookUp_shank[i];
            closestIndex = i;
            minDiff = diff;
        }
    }

    float theta_thigh_x = angle[0];
    float theta_thigh_y = LookUp_thigh[closestIndex];
    float theta_thigh_z = angle[2];
    return{theta_thigh_x, theta_thigh_y, theta_thigh_z};
}

// Function to calculate cross product of two 3D vectores
vector <float> crossProduct(vector <float> vect_A, vector <float> vect_B){
    float cross_Px = vect_A[1] * vect_B[2] - vect_A[2] * vect_B[1];
    float cross_Py = vect_A[2] * vect_B[0] - vect_A[0] * vect_B[2];
    float cross_Pz = vect_A[0] * vect_B[1] - vect_A[1] * vect_B[0];
    return {cross_Px, cross_Py, cross_Pz};
}

    // Function to integrate 
    vector<float> integrate(vector<float> a, vector<float> pre_a, vector<float> v, float dt) {
         float vx = v[0] + 0.5f * (a[0] + pre_a[0]) * dt;
         float vy = v[1] + 0.5f * (a[1] + pre_a[1]) * dt;
         float vz = v[2] + 0.5f * (a[2] + pre_a[2]) * dt;
         return {vx, vy, vz};
    }

    // Function to differentiate
    vector <float> differentiate(vector <float> a, vector <float> pre_a, float dt){
        float bx = (a[0] - pre_a[0]) / dt;
        float by = (a[1] - pre_a[1]) / dt;
        float bz = (a[2] - pre_a[2]) / dt;
    return {bx, by, bz};
    }

    // Function to calculate GRF
    vector <float> calculate_grf(vector <float> a_shank, vector <float> a_thigh, vector <float> a_hip, float m){
        float m_shank = 0.057*m;
        float m_thigh = 0.1416*m;
        float m_hip = 0.5*0.6028*m;
        float g = 9.81;
        float grf_x = m_shank*(a_shank[0]) + m_thigh*(a_thigh[0]) + m_hip*(a_hip[0]);
        float grf_y = m_shank*(a_shank[1]) + m_thigh*(a_thigh[1]) + m_hip*(a_hip[1]);
        float grf_z = m_shank*(a_shank[2]-g) + m_thigh*(a_thigh[2]-g) + m_hip*(a_hip[2]-g);
        return {grf_x, grf_y, grf_z};
    }

    // Function to detect steps based on angle shank (not using this!!)
    // int detect_step_angle(vector <float> angle, vector <float> threshold){
    //     int stepTest;
    //     if(angle[0] < threshold[0]){
    //         stepTest = 1; // Step detected
    //     } else {
    //         stepTest = 0; // No step detected
    //     }
    //     return stepTest;
    // }

    pair<int, float> detect_step_pico(float stepCounter, float pre_stepCounter, float timestamp){
        int stepEvent;
        float timeEvent;
        if(stepCounter == pre_stepCounter){
            stepEvent = 0;
        }
        else {
            stepEvent = 1;
            timeEvent = timestamp;
        }
        return make_pair(stepEvent, timeEvent);
    }

    int detect_step(int stepEvent, float timeEvent, float timeStamp){
        int stepDetector;
            if (timeEvent + 200.0f > timeStamp){
                stepDetector = 1;
            }
            else {
                stepDetector = 0;
            }
            return stepDetector;
    }

    bool ADCthreshold(float adcresult, float conversion_factor){
        bool adcbool;
        if (adcresult * conversion_factor >= 0.03) {
            adcbool = true;
        }
        else {
            adcbool = false;
        }
        return adcbool;
    }

    // Print function
    void print_csv(const vector<float>& times, const vector<vector<float>>& GRFs, const vector<vector<float>>& accelerations, const vector<vector<float>>& gyros, const vector<vector<float>>& angles, const vector<vector<float>>& accelerationsRaw, const vector<vector<float>>& gyrosRaw, const vector<vector<float>>& anglesRaw, const vector<float>& steps , const vector<float>& counter) {
        // Print CSV header
    
        // Iterate through the data and print each row
        for (size_t i = 0; i < times.size(); ++i) {

            printf("%.8f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f,%.3f\n", 
                    times[i],
                    GRFs[i][0], GRFs[i][1], GRFs[i][2],
                    accelerations[i][0], accelerations[i][1], accelerations[i][2],
                    gyros[i][0], gyros[i][1], gyros[i][2],
                    angles[i][0], angles[i][1], angles[i][2],
                    accelerationsRaw[i][0], accelerationsRaw[i][1], accelerationsRaw[i][2],
                    gyrosRaw[i][0], gyrosRaw[i][1], gyrosRaw[i][2],
                    anglesRaw[i][0], anglesRaw[i][1], anglesRaw[i][2],
                    steps[i],
                    counter[i]);
        }
    }
    
    // CHANGE: FILTER IMU
    // Filter IMU data
    vector<float> filter_ema(vector<float> current, vector<float> previous, float alpha) {
        return {
            previous[0] + alpha * (current[0] - previous[0]),
            previous[1] + alpha * (current[1] - previous[1]),
            previous[2] + alpha * (current[2] - previous[2])
        };
    }
    
void get_GRF(float* result, float m, float L_shank_ini, float L_thigh_ini){ 
    if (IMU.getSensorEvent() == false) {
        result[0] = 0.0f;
        result[1] = 0.0f;
        result[2] = -1.0f;
        result[3] = 0.0f;
        return; // No sensor event, exit the function
    }

    // Read sensor data
    if (IMU.getSensorEvent() == true){
    
        // CHANGE: SENSORIDS
        if (IMU.getSensorEventID() == SENSOR_REPORTID_GAME_ROTATION_VECTOR) {   
            yaw = IMU.getGameYaw();
            pitch = IMU.getGamePitch();
            roll = IMU.getRoll();
        }
        
        if (IMU.getSensorEventID() == SENSOR_REPORTID_LINEAR_ACCELERATION) {
            accX = IMU.getLinAccelX();
            accY = IMU.getLinAccelY();
            accZ = IMU.getLinAccelZ();
        }
        
        if (IMU.getSensorEventID() == SENSOR_REPORTID_GYROSCOPE_CALIBRATED) {
            gyroX = IMU.getGyroX();
            gyroY = IMU.getGyroY();
            gyroZ = IMU.getGyroZ();
        }
        
        timeStamp = (time_us_64() / 1000.0f) - start_time; // Time in seconds

        if (IMU.getSensorEventID() == SENSOR_REPORTID_STEP_COUNTER) {
            stepCounter = IMU.getStepCount();
        }

    }

    // CHANGE: RAW DATA AND FILTERED DATA
    // Store sensor data in vector
    a_IMU_raw = {accZ, accY, accX};
    w_IMU_raw = {gyroZ, gyroY, gyroX};
    angle_IMU_raw = {roll, pitch, yaw};

    // Filter sensor data
    a_IMU = filter_ema(a_IMU_raw, a_IMU, alpha);
    w_IMU = filter_ema(w_IMU_raw, w_IMU, alpha);
    angle_IMU = angle_IMU_raw;
    
    angle_thigh = estimate_angle_thigh(angle_IMU, LookUp_shank, LookUp_thigh);

    // Calculate Length vectors
    L_shank= calculate_length(angle_IMU, L_shank_ini);
    L_shank_COM = entrywise_mul(L_shank, COM_shank);
    L_thigh= calculate_length(angle_thigh, L_thigh_ini);
    L_thigh_COM = entrywise_mul(L_thigh, (1-COM_thigh));

    // Integrate a_IMU to obtain v_IMU
    v_IMU= integrate(a_IMU, pre_a_IMU, v_IMU, dt);
    
    // Calculate velocity and acceleration shank
    v_shank = entrywise_add(v_IMU, crossProduct(w_IMU,L_shank_COM));
    a_shank = differentiate(v_shank, pre_v_shank, dt);

    // Calculate velocity knee
    v_knee= entrywise_add(v_IMU, crossProduct(w_IMU,L_shank));

    // Calculate velocity and acceleration thigh
    w_thigh = differentiate(angle_thigh, pre_angle_thigh, dt);
    v_thigh= entrywise_add(v_knee, crossProduct(w_thigh,L_thigh_COM));
    a_thigh = differentiate(v_thigh, pre_v_thigh, dt);

    // Calculate velocity and acceleration hip
    v_hip= entrywise_add(v_knee, crossProduct(w_thigh,L_thigh));
    a_hip = differentiate(v_hip, pre_v_hip, dt);


    //stepDetector = detect_step_angle(angle_IMU, thresholdAngle);
    auto [stepEvent, timeEvent] = detect_step_pico(stepCounter, pre_stepCounter, timeStamp);
    stepDetector = detect_step(stepEvent, timeEvent, timeStamp);

    // Assign current value to previous value
    pre_angle_thigh = angle_thigh;
    pre_v_thigh = v_thigh;
    pre_v_hip = v_hip;
    pre_v_shank = v_shank;
    pre_a_IMU = a_IMU;
    pre_stepCounter = stepCounter;

    // Calculate GRF
    GRF = calculate_grf(a_shank, a_thigh, a_hip, m);

    // Return GRF, timestamp, stepDetector timeEvent for transmission
    magnitude = sqrt(GRF[0]*GRF[0] + GRF[1]*GRF[1] + GRF[2]*GRF[2]);    
    result[0] = magnitude;
    result[1] = timeStamp;
    result[2] = (float)stepDetector;
    result[3] = timeEvent;
}
